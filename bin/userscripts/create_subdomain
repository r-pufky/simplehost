#!/usr/bin/php4
<?
# Robert Pufky
# 2006-06-13 - User subdomain creation script

$fatal = true;  //constant for fatal error

# if no command line options are given.
if( $_SERVER['argc'] != 2 ) {
	error($fatal,"Invalid command line arguments.");
} else {
	# what subdomain are we creating
	$subdomain = $argv[1];
	# find out who we are
	$user = exec("whoami");
	# figure out the domain name
	$domain = str_replace(" ","",str_replace("-",".",$user));

	# sanity check - only create if subdirectory does not exist!
	if( file_exists("/home/$user/www/$subdomain") ) {
		error($fatal,"\nDirectory exists where subdomain would be created: /home/$user/www/$subdomain\n  Move directory, or rename and try again.\n");
	} else {
		exec("mkdir /home/$user/www/$subdomain");
		exec("chgrp www-data /home/$user/www/$subdomain");
	}

	# Create the virtualhost template for apache2
	exec("echo '<VirtualHost *:80>
  ServerName $subdomain.$domain
  ServerAdmin webmaster@$subdomain.$domain
  DocumentRoot /home/$user/www/$subdomain
  ErrorLog /home/$user/logs/$subdomain.$domain-error.log
  CustomLog /home/$user/logs/$subdomain.$domain-access.log common
</VirtualHost>' >> /home/$user/etc/apache.conf");
	# setup logfiles
	exec("touch /home/$user/logs/$subdomain.$domain-error.log /home/$user/logs/$subdomain.$domain-access.log");
	exec("chmod 660 /home/$user/logs/$subdomain.$domain-error.log /home/$user/logs/$subdomain.$domain-access.log");
	echo "\n\nCreated '$subdomain.$domain'.\n\tPlease tweak configuration to your needs, then contact an admin to enable the subdomain.\n\n";
}

# print out error/warning messages
function error($fatal,$message) {
	# log entry to the database (date, time, message)
	
	# print message
	if( $fatal ) {
		print "\nError: $message\n\n";
	} else {
		print "\nWarning: $message\n";
	}
	die("Usage:\n\tcreate_subdomain <subdomain>\n\n\tSubdomain is the subdomain without the domain:\n\t\tfruity.abc.com --enter-this-> 'fruity'\n\nNO subdomains modified.\n\n");
}
?>
